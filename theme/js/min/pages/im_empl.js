!function(e){function t(i){if(s[i])return s[i].exports;var n=s[i]={exports:{},id:i,loaded:!1};return e[i].call(n.exports,n,n.exports,t),n.loaded=!0,n.exports}var s={};return t.m=e,t.c=s,t.p="",t(0)}([function(e,t,s){"use strict";var i=s(3);$(document).ready(function(){new i.PageCompanyMessView})},,,function(e,t){"use strict";var s=function(){function e(){this.lastMessId=0,this.T1NewMess=0,this.idTheme=0;var e=this;e.init()}return e.prototype.init=function(){var e=this;if(e.idTheme=G_VARS.idTm,G_VARS.idTm||G_VARS.isNew){e.setChatSize({isNew:G_VARS.isNew}),G_VARS.isNew||e.getMessages(0),$(".go button").click(function(t){e.sendMessage(t,this)}),G_VARS.isNew||e.chkNewMessages(),$("#Mmessage").length&&e.initEditor(),$("#DiButtonPanel .js-attach-file").click(function(t){e.onAttachClickFn(t,this)}),G_VARS.isNew&&$("#DiButtonPanel .js-attach-file").hide();var t=new Uploaduni;e.uploaduni=t,t.init({uploadConnector:MainConfig.AJAX_POST_UPLOADUNI_EX,scope:"im",imgBlockTmpl:"attached-image-tpl",filesBlockTmpl:"attached-file-tpl",imgsWrapper:"#DiImgs",filesWrapper:"#DiFiles",lnktoimg:"orig",uploadForm:"#F2upload",messageBlock:".message",loadingBLock:".loading-ico",onDeleteEnd:function(e){$("#DiImgs").find(".uni-delete").length<1&&$("#DiFiles").find(".uni-delete").length<1&&$("#F3uploaded").fadeOut(200)}}),G_VARS.isNew||t.setFiles(G_VARS.uniFiles)}},e.prototype.getMessages=function(e){void 0===e&&(e=0);var t=this;G_VARS.App.showLoading($("#DiMessagesWrapp"),0,{top:1,variant:2}),$.get(MainConfig.AJAX_GET_GETUSERMESAGES,{tm:G_VARS.idTm,fid:e},function(s){s=JSON.parse(s),t.prependMessages(s.data,s.count,e>0);var i=0;$(".mess-box").each(function(){var e=$(this);if(e.hasClass("mess-from")&&e.hasClass("unread")){if(i||(i=1),!$(".new-mess").length){var t=$(".new-mess-tpl").clone();t.toggleClass("new-mess-tpl new-mess tmpl"),e.before(t)}i&&e.addClass("-new"),$("#DiMessagesInner").height($("#DiMessages").outerHeight())}})}).always(function(){G_VARS.App.hideLoading()})},e.prototype.onAtachFileChangeFn=function(e,t){var s=this;$(t);s.uploaduni.uploadEx({uploadInput:t,meta:{idTheme:s.idTheme},onSuccessEnd:function(e){$("#F3uploaded").fadeIn(400),ModalWindow.close(),Hinter.bind(e.find(".js-hashint"))},onAfterUpload:function(e){for(var t in e.file.files){e.file.files[t];e.file.files[t]+=","+s.idTheme}return e}})},e.prototype.onAttachClickFn=function(e,t){var s=this;$(t);e.preventDefault();var i=$("#TmplF2upload").html();ModalWindow.open({content:i,action:{active:0},bgIsCloseBtn:0,position:"fixed",context:"#DiContent",afterOpen:function(){ModalWindow.content.find(".btn-upload button").click(function(e){$("#UplImg").click()}),ModalWindow.content.find("#UplImg").change(function(e){s.onAtachFileChangeFn(e,this)})}})},e.prototype.chkNewMessages=function(){var e=this;e.T1NewMess=setTimeout(function t(){G_VARS.App.showLoading2($(".header-021"),{outerAlign:"left",offsetX:-10}),$.get(MainConfig.AJAX_GET_GETNEWMESAGES,{tm:G_VARS.idTm,l:e.lastMessId},function(s){s=JSON.parse(s),e.appendMessages(s.messages),e.T1NewMess=setTimeout(t,5e3)}).always(function(){G_VARS.App.hideLoading()})},5e3)},e.prototype.appendMessages=function(e){var t=this,s=$("#DiMessages"),i=0;for(var n in e){var a,o=e[n];if(0==o.isresp?(a=$(".mess-from.tmpl").clone(),a.find(".fio").text(o.namefrom)):(a=$(".mess-to.tmpl").clone(),a.find(".fio").text(o.nameto)),"0"==o.isread&&"0"==o.isresp){if(!$(".new-mess").length){var l=$(".new-mess-tpl").clone();l.toggleClass("new-mess-tpl new-mess tmpl"),s.append(l)}i=1}i&&a.addClass("-new"),a.find(".date").text(o.crtime+" "+o.crdate),a.find(".mess").html(o.message.replace("\n","<br/>")),t.prependFiles({block:a,data:o}),s.append(a),a.hide(),a.removeClass("tmpl"),a.fadeIn(400,function(){var e=document.getElementById("DiMessagesWrapp");e.scrollTop=e.scrollHeight}),$("#DiMessagesInner").height(s.outerHeight()),a.find(".files img").one("load",function(){$("#DiMessagesInner").height(s.outerHeight())}),parseInt(t.lastMessId)<parseInt(o.id)&&(t.lastMessId=o.id)}},e.prototype.onPrevMessClickFn=function(e,t,s){var i=this;e.preventDefault(),i.getMessages(s)},e.prototype.prependMessages=function(e,t,s){var i=this,n=$("#DiMessages"),a=$("#DiMessagesInner");$(".prev-mess").remove();var o=0;for(var l in e){var r,d=e[l];0==d.isresp?(r=$(".mess-from.tmpl").clone(),r.find(".fio").text(d.namefrom)):(r=$(".mess-to.tmpl").clone(),r.find(".fio").text(d.nameto)),"0"==d.isread&&r.addClass("unread"),r.find(".date").text(d.crtime+" "+d.crdate),r.find(".mess").html(d.message.replace("\n","<br/>")),i.prependFiles({block:r,data:d}),n.prepend(r),r.hide(),r.removeClass("tmpl"),r.fadeIn(400,function(){if(!s){var e=document.getElementById("DiMessagesWrapp");e.scrollTop=e.scrollHeight}}),o||(o=a.height()),a.height(n.outerHeight()),r.find(".files img").one("load",function(){a.height(n.outerHeight()),$("#DiMessagesWrapp")[0].scrollTop=a.height()}),i.setChatSize(),parseInt(i.lastMessId)<parseInt(d.id)&&(i.lastMessId=d.id)}if(s&&($("#DiMessagesWrapp")[0].scrollTop=a.height()-o),parseInt(t)){var p=$(".prev-mess-tpl").clone();p.toggleClass("prev-mess-tpl tmpl prev-mess"),p.click(function(t){i.onPrevMessClickFn(t,this,e[e.length-1].id)}),n.prepend(p),a.height(n.outerHeight())}},e.prototype.prependFiles=function(e){var t=this,s=e.block,i=e.data,n=s.find(".files"),a=s.find(".mess"),o=n.find("a").clone(),l=n.find(".js-container").clone();n.empty();var r=0,d=l.clone();for(var r in i.files){var p=i.files[r];if("files"==p.meta.type){var f=o.clone();f.attr("href",p.files.orig+","+t.idTheme).text(p.meta.name),d.append(f),r++}}r&&n.append(d.addClass("-files clearfix")),r=0,d=l.clone();for(var r in i.files){var p=i.files[r];if("images"==p.meta.type){var f=o.clone();f.attr("href",p.files.orig+","+t.idTheme),f.find("img").attr("src",p.files.tb+","+t.idTheme),d.append(f),r++}}""!=n.html()&&n.appendTo(a),r&&(n.append(d.addClass("-images")),n.magnificPopup({delegate:".-images a",type:"image",gallery:{enabled:!0,preload:[0,2],navigateByImgClick:!0,arrowMarkup:'<button title="%title%" type="button" class="mfp-arrow mfp-arrow-%dir%"></button>',tPrev:"",tNext:"",tCounter:'<span class="mfp-counter">%curr% / %total%</span>'}}))},e.prototype.sendMessage=function(e,t){var s=this,i=$(t);if(e.preventDefault(),""!=s.NicEditor.nicInstances[0].getContent().replace("<br>","").trim()){G_VARS.App.showLoading2(i,{outerAlign:"left",valign:"top",offsetX:-10,offsetY:3});var n=1;if(G_VARS.isNew){var a,o;if($("#EdTheme").val()?a=$("#EdTheme").val():"aa"!=$("#CBTheme").val()&&(o=$("#CBTheme").val()),!a&&!o){var l=$("#CBTheme");$("body").stop().animate({scrollTop:l.offset().top-30+"px"},500,function(){var e=$(".error-hint-box");e.text("Выберите или введите тему").css({left:l.offset().left,top:l.offset().top+l.outerHeight()+10}),e.fadeIn(400),l.addClass("field--warning"),l.focus(),l.on("blur",function(){e.fadeOut(200),l.removeClass("field--warning"),$(this).off("blur")})}),G_VARS.App.hideLoading(),n=0}var r={new:G_VARS.isNew,m:s.NicEditor.nicInstances[0].getContent()};a?r.t=a:o&&(r.vid=o)}else var r={tm:G_VARS.idTm,m:s.NicEditor.nicInstances[0].getContent(),l:s.lastMessId};n&&$.post(MainConfig.AJAX_POST_SENDUSERMESAGES,r,function(e){clearTimeout(s.T1NewMess),e=JSON.parse(e);var t=$("#DiMessages");$("#Mmessage").val(""),s.NicEditor.nicInstances[0].setContent(""),$(".message-box .nicEdit-main").focus(),$("#F3uploaded").fadeOut(200,function(){return $("#DiImgs").empty()}),G_VARS.isNew&&($(".nomess").fadeOut(200,function(){$(this).remove()}),$(".theme-input").slideUp(200,function(){$(this).remove()}),$(".header-021 b").text(e.theme),history.pushState(null,null,"/"+MainConfig.PAGE_IM+"/"+e.idtm),G_VARS.idTm=e.idtm,s.idTheme=e.idtm,G_VARS.isNew=0,$("#DiButtonPanel .js-attach-file").fadeIn(200));var i=0;$(".new-mess").remove(),$(".mess-box.-new").removeClass("-new");for(var n in e.messages){var a,o=e.messages[n];if(0==o.isresp?(a=$(".mess-from.tmpl").clone(),a.find(".fio").text(o.namefrom)):(a=$(".mess-to.tmpl").clone(),a.find(".fio").text(o.nameto)),"0"==o.isread&&"0"==o.isresp&&!$(".new-mess").length){var l=$(".new-mess-tpl").clone();l.toggleClass("new-mess-tpl new-mess tmpl"),t.append(l),i=1}i&&a.addClass("-new"),a.find(".date").text(o.crtime+" "+o.crdate),a.find(".mess").html(o.message.replace("\n","<br/>")),s.prependFiles({block:a,data:o}),t.append(a),a.hide(),a.removeClass("tmpl"),a.fadeIn(400,function(){var e=document.getElementById("DiMessagesWrapp");e.scrollTop=e.scrollHeight}),$("#DiMessagesInner").height(t.outerHeight()),a.find(".files img").one("load",function(){$("#DiMessagesInner").height(t.outerHeight())}),parseInt(s.lastMessId)<parseInt(o.id)&&(s.lastMessId=o.id)}s.chkNewMessages()}).always(function(){G_VARS.App.hideLoading()})}},e.prototype.initEditor=function(){var e=this,t=new nicEditor({maxHeight:52,buttonList:["bold","italic","underline"]});e.NicEditor=t,t.addInstance("Mmessage"),t.setPanel("DiButtonPanel")},e.prototype.setChatSize=function(e){void 0===e&&(e={});$("#DiChatWrapp").height($(window).innerHeight()),e.isNew||$("html, body").animate({scrollTop:$(".mess-box-end").offset().top},0)},e}();t.PageCompanyMessView=s}]);